<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #eef2ff;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --accent-color: #f72585;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --background-color: #f8fafc;
            --card-bg: #ffffff;
            --user-message-bg: #eef2ff;
            --assistant-message-bg: #fafafa;
            --system-message-bg: #fff8e6;
            --text-color: #333333;
            --text-secondary: #5e6e82;
            --text-light: #8b94a3;
            --border-color: #e9ecef;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --transition: 0.3s ease;
        }

        /* Dark Mode Variables */
        .dark-mode {
            --primary-color: #6366f1;
            --primary-light: #2a3158;
            --primary-dark: #818cf8;
            --secondary-color: #9333ea;
            --accent-color: #ec4899;
            --background-color: #0f172a;
            --card-bg: #1e293b;
            --user-message-bg: #2a3158;
            --assistant-message-bg: #1e293b;
            --system-message-bg: #2d2a33;
            --text-color: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-light: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition), color var(--transition);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* App Layout */
        .app-layout {
            display: flex;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            transition: transform var(--transition), width var(--transition);
            z-index: 10;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.25rem;
        }

        .logo-icon {
            font-size: 20px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
        }

        .chat-header-title {
            display: flex;
            flex-direction: column;
        }

        .chat-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .system-message-display {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background: var(--background-color);
        }

        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius);
            animation: fadeInUp 0.3s ease;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .user-message {
            align-self: flex-end;
            background: var(--user-message-bg);
            color: var(--text-color);
            border-bottom-right-radius: 4px;
        }

        .assistant-message {
            align-self: flex-start;
            background: var(--assistant-message-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .system-message {
            align-self: center;
            background: var(--system-message-bg);
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9rem;
            max-width: 90%;
            border-left: 3px solid var(--accent-color);
        }

        .message-content {
            word-break: break-word;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
        }

        .message-content p {
            margin-bottom: 0.75rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            transition: border-color var(--transition), box-shadow var(--transition);
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .chat-input {
            flex: 1;
            border: none;
            padding: 0.75rem;
            background: transparent;
            color: var(--text-color);
            resize: none;
            min-height: 24px;
            max-height: 150px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }

        .send-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: background-color var(--transition), transform var(--transition);
        }

        .send-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .send-button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
            transform: scale(1);
        }

        /* Chats List */
        .sidebar-section-title {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chats-list, .system-messages-list {
            list-style: none;
        }

        .chat-item, .system-message-item {
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color var(--transition);
            position: relative;
        }

        .chat-item:hover, .system-message-item:hover {
            background-color: var(--primary-light);
        }

        .chat-item.active, .system-message-item.active {
            background-color: var(--primary-light);
            border-right: 3px solid var(--primary-color);
        }

        .chat-item-icon, .system-message-item-icon {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: var(--primary-light);
            border-radius: 50%;
            color: var(--primary-color);
        }

        .chat-item-content, .system-message-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-item-title, .system-message-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-date, .system-message-item-preview {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-actions, .system-message-item-actions {
            opacity: 0;
            transition: opacity var(--transition);
            display: flex;
            gap: 4px;
        }

        .chat-item:hover .chat-item-actions, 
        .system-message-item:hover .system-message-item-actions {
            opacity: 1;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            padding: 6px;
            border-radius: 50%;
            transition: background-color var(--transition), color var(--transition);
        }

        .chat-action-btn:hover {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        /* New Chat Button */
        .new-button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color var(--transition), transform var(--transition);
            margin: 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .new-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.02);
        }

        /* Sidebar Tabs */
        .sidebar-tabs {
            display: flex;
            background: var(--card-bg);
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color var(--transition), background-color var(--transition);
            border-radius: var(--border-radius-sm);
            font-weight: 500;
        }

        .sidebar-tab:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .sidebar-tab.active {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        /* Tab Panels */
        .tab-panel {
            display: none;
            height: 100%;
            overflow-y: auto;
        }

        .tab-panel.active {
            display: block;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition), visibility var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 540px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform var(--transition);
            box-shadow: var(--shadow-lg);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: background-color var(--transition);
        }

        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--danger-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color var(--transition), box-shadow var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .form-select {
            appearance: none;
            padding-right: 2.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%235e6e82'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: background-color var(--transition), color var(--transition), transform var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-outline:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* System Messages Styling */
        .saved-system-message {
            background: var(--primary-light);
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: transform var(--transition), box-shadow var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .saved-system-message:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .saved-system-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .saved-system-message-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .saved-system-message-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Typing indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            margin: 0.75rem 0 0.75rem 1.25rem;
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: all 0.3s;
        }

        .typing-indicator.active {
            opacity: 1;
            height: 30px;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: var(--primary-color);
            display: block;
            border-radius: 50%;
            opacity: 0.4;
        }

        .typing-indicator span:nth-of-type(1) {
            animation: typing 1s infinite;
        }

        .typing-indicator span:nth-of-type(2) {
            animation: typing 1s 0.33s infinite;
        }

        .typing-indicator span:nth-of-type(3) {
            animation: typing 1s 0.66s infinite;
        }

        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
            text-align: center;
            height: 100%;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-light);
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            max-width: 300px;
        }

        /* System Messages Preview */
        .system-message-preview {
            border-radius: var(--border-radius);
            background: var(--system-message-bg);
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--accent-color);
        }

        .system-message-preview-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .system-message-preview-content {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
                box-shadow: var(--shadow-lg);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .menu-toggle {
                display: block;
            }

            .message {
                max-width: 90%;
            }

            .system-message-display {
                max-width: 150px;
            }

            .chat-header {
                padding: 0.875rem 1rem;
            }

            .chat-input-container {
                padding: 0.875rem 1rem;
            }

            .modal {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-robot logo-icon"></i>
                    <span>AI Chat</span>
                </div>
                <button id="theme-toggle" class="chat-action-btn" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="chats">Chats</div>
                <div class="sidebar-tab" data-tab="system-messages">System Prompts</div>
            </div>

            <div class="sidebar-content">
                <!-- Chats Tab -->
                <div class="tab-panel active" id="chats-panel">
                    <button class="new-button" id="new-chat-btn">
                        <i class="fas fa-plus"></i>
                        <span>New Chat</span>
                    </button>
                    
                    <div id="chats-container">
                        <div class="sidebar-section-title">Recent Conversations</div>
                        <ul class="chats-list" id="chats-list">
                            <!-- Dynamic chat items will be added here -->
                        </ul>
                    </div>
                </div>

                <!-- System Messages Tab -->
                <div class="tab-panel" id="system-messages-panel">
                    <button class="new-button" id="new-system-message-btn">
                        <i class="fas fa-plus"></i>
                        <span>New System Prompt</span>
                    </button>
                    
                    <div id="system-messages-container">
                        <div class="sidebar-section-title">Saved Prompts</div>
                        <ul class="system-messages-list" id="system-messages-list">
                            <!-- Dynamic system message items will be added here -->
                        </ul>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <span id="model-info">Loading model info...</span>
                <button class="chat-action-btn" id="settings-btn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-header-title">
                        <div class="chat-title" id="current-chat-title">New Chat</div>
                        <div class="system-message-display" id="current-system-message">
                            System: You are a helpful assistant.
                        </div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="chat-action-btn" id="change-system-btn" title="Change System Prompt">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                    <button class="chat-action-btn" id="clear-chat-btn" title="Clear Chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Welcome message will be here -->
                </div>

                <div class="typing-indicator" id="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="user-input" placeholder="Type your message..." rows="1"></textarea>
                        <button class="send-button" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div class="modal-overlay" id="new-chat-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">New Conversation</div>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="new-chat-title">Chat Title</label>
                    <input type="text" class="form-control" id="new-chat-title" placeholder="e.g. Coding Assistant">
                </div>
                
                <div class="form-group">
                    <label class="form-label">System Prompt</label>
                    <div class="system-message-preview" id="selected-system-preview">
                        <div class="system-message-preview-title">
                            <i class="fas fa-cog"></i>
                            <span id="selected-system-title">Default Assistant</span>
                        </div>
                        <div class="system-message-preview-content" id="selected-system-content">
                            You are a helpful assistant.
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose a System Prompt:</label>
                    <select class="form-control form-select" id="saved-system-messages">
                        <option value="">-- Select a saved prompt --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-chat-system-message">Or create a custom prompt:</label>
                    <textarea class="form-control" id="new-chat-system-message" rows="3" placeholder="e.g. You are a helpful coding assistant..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-close-modal>Cancel</button>
                <button class="btn btn-primary" id="create-chat-btn">Create</button>
            </div>
        </div>
    </div>

    <!-- System Message Modal -->
    <div class="modal-overlay" id="system-message-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create System Prompt</div>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="system-message-name">Prompt Name</label>
                    <input type="text" class="form-control" id="system-message-name" placeholder="e.g. Coding Expert">
                </div>
                <div class="form-group">
                    <label class="form-label" for="system-message-content">Prompt Content</label>
                    <textarea class="form-control" id="system-message-content" rows="5" placeholder="e.g. You are an expert in Python programming..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-close-modal>Cancel</button>
                <button class="btn btn-primary" id="save-system-message-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Change System Message Modal -->
    <div class="modal-overlay" id="change-system-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Change System Prompt</div>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Current System Prompt:</label>
                    <div class="system-message-preview">
                        <div class="system-message-preview-content" id="current-system-preview">
                            You are a helpful assistant.
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select a Saved Prompt:</label>
                    <div id="system-prompts-container" class="system-prompts-grid">
                        <!-- System prompts will be displayed here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="current-system-message-input">Or create a custom prompt:</label>
                    <textarea class="form-control" id="current-system-message-input" rows="4" placeholder="Enter custom system prompt..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-close-modal>Cancel</button>
                <button class="btn btn-primary" id="update-system-message-btn">Update</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const messagesContainer = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const newSystemMessageBtn = document.getElementById('new-system-message-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const changeSystemBtn = document.getElementById('change-system-btn');
        const modelInfo = document.getElementById('model-info');
        const chatsList = document.getElementById('chats-list');
        const systemMessagesList = document.getElementById('system-messages-list');
        const currentChatTitle = document.getElementById('current-chat-title');
        const currentSystemMessage = document.getElementById('current-system-message');
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const tabPanels = document.querySelectorAll('.tab-panel');
        const systemPromptsContainer = document.getElementById('system-prompts-container');
        const selectedSystemTitle = document.getElementById('selected-system-title');
        const selectedSystemContent = document.getElementById('selected-system-content');
        const currentSystemPreview = document.getElementById('current-system-preview');

        // Modal Elements
        const modalOverlays = document.querySelectorAll('.modal-overlay');
        const closeModalButtons = document.querySelectorAll('[data-close-modal]');
        const newChatModal = document.getElementById('new-chat-modal');
        const systemMessageModal = document.getElementById('system-message-modal');
        const changeSystemModal = document.getElementById('change-system-modal');
        const createChatBtn = document.getElementById('create-chat-btn');
        const saveSystemMessageBtn = document.getElementById('save-system-message-btn');
        const updateSystemMessageBtn = document.getElementById('update-system-message-btn');
        const newChatTitle = document.getElementById('new-chat-title');
        const newChatSystemMessage = document.getElementById('new-chat-system-message');
        const systemMessageName = document.getElementById('system-message-name');
        const systemMessageContent = document.getElementById('system-message-content');
        const currentSystemMessageInput = document.getElementById('current-system-message-input');
        const savedSystemMessagesDropdown = document.getElementById('saved-system-messages');

        // Application State
        let state = {
            chats: [],
            systemMessages: [],
            currentChatId: null,
            isDarkMode: false
        };

        // API Service for saving and loading data from server
        const APIService = {
            // Load all chats
            async loadChats() {
                try {
                    const response = await fetch('/api/chats');
                    if (response.ok) {
                        return await response.json();
                    }
                    return [];
                } catch (error) {
                    console.error('Error loading chats:', error);
                    return [];
                }
            },
            
            // Save a chat
            async saveChat(chat) {
                try {
                    const response = await fetch('/api/chats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(chat)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error saving chat:', error);
                    return false;
                }
            },
            
            // Update a chat
            async updateChat(chat) {
                try {
                    const response = await fetch(`/api/chats/${chat.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(chat)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error updating chat:', error);
                    return false;
                }
            },
            
            // Delete a chat
            async deleteChat(chatId) {
                try {
                    const response = await fetch(`/api/chats/${chatId}`, {
                        method: 'DELETE'
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    return false;
                }
            },
            
            // Load all system messages
            async loadSystemMessages() {
                try {
                    const response = await fetch('/api/system-messages');
                    if (response.ok) {
                        return await response.json();
                    }
                    return [];
                } catch (error) {
                    console.error('Error loading system messages:', error);
                    return [];
                }
            },
            
            // Save a system message
            async saveSystemMessage(message) {
                try {
                    const response = await fetch('/api/system-messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(message)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error saving system message:', error);
                    return false;
                }
            },
            
            // Delete a system message
            async deleteSystemMessage(messageId) {
                try {
                    const response = await fetch(`/api/system-messages/${messageId}`, {
                        method: 'DELETE'
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error deleting system message:', error);
                    return false;
                }
            },
            
            // Save settings
            async saveSettings(settings) {
                try {
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error saving settings:', error);
                    return false;
                }
            },
            
            // Load settings
            async loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading settings:', error);
                    return null;
                }
            }
        };

        // Initialize the application
        async function init() {
            // Show welcome message
            showWelcomeMessage();
            
            // Load settings
            const settings = await APIService.loadSettings();
            if (settings) {
                state.isDarkMode = settings.isDarkMode || false;
                
                // Apply dark mode if saved
                if (state.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            }
            
            // Load chats and system messages
            state.chats = await APIService.loadChats() || [];
            state.systemMessages = await APIService.loadSystemMessages() || [];
            
            // Setup event listeners
            setupEventListeners();
            
            // Render UI
            renderChats();
            renderSystemMessages();
            updateSystemMessagesDropdown();
            
            // Create default system message if none exists
            if (state.systemMessages.length === 0) {
                const defaultMessage = {
                    id: generateId(),
                    name: 'Default Assistant',
                    content: 'You are a helpful assistant.'
                };
                
                state.systemMessages.push(defaultMessage);
                await APIService.saveSystemMessage(defaultMessage);
                renderSystemMessages();
                updateSystemMessagesDropdown();
            }
            
            // Load the last chat or create a new one
            if (state.chats.length > 0) {
                // Find the most recently updated chat
                const sortedChats = [...state.chats].sort((a, b) => b.updatedAt - a.updatedAt);
                state.currentChatId = sortedChats[0].id;
                loadChat(state.currentChatId);
            } else {
                // Show empty state
                showEmptyChatState();
            }
            
            // Fetch model info
            fetchModelInfo();
        }

        // Show welcome message
        function showWelcomeMessage() {
            messagesContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments empty-state-icon"></i>
                    <div class="empty-state-title">Welcome to AI Chat</div>
                    <div class="empty-state-text">
                        Start a new conversation or select a previous chat from the sidebar.
                    </div>
                    <button class="btn btn-primary" id="welcome-new-chat-btn">
                        <i class="fas fa-plus"></i> New Chat
                    </button>
                </div>
            `;
            
            // Add event listener to the welcome new chat button
            document.getElementById('welcome-new-chat-btn').addEventListener('click', () => {
                openModal(newChatModal);
            });
        }

        // Show empty chat state
        function showEmptyChatState() {
            currentChatTitle.textContent = 'No Active Chat';
            currentSystemMessage.textContent = 'Start a new conversation';
            
            messagesContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comment-slash empty-state-icon"></i>
                    <div class="empty-state-title">No Active Conversation</div>
                    <div class="empty-state-text">
                        Start a new chat or select one from the sidebar.
                    </div>
                    <button class="btn btn-primary" id="empty-new-chat-btn">
                        <i class="fas fa-plus"></i> New Chat
                    </button>
                </div>
            `;
            
            // Add event listener to the empty new chat button
            document.getElementById('empty-new-chat-btn').addEventListener('click', () => {
                openModal(newChatModal);
            });
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);

            // Mobile menu toggle
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Sidebar tabs
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    sidebarTabs.forEach(t => t.classList.remove('active'));
                    tabPanels.forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tabName}-panel`).classList.add('active');
                });
            });

            // Modal close buttons
            closeModalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.modal-overlay');
                    closeModal(modal);
                });
            });

            // Modal overlay click to close
            modalOverlays.forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay);
                    }
                });
            });

            // New chat button
            newChatBtn.addEventListener('click', () => {
                openModal(newChatModal);
                setTimeout(() => newChatTitle.focus(), 100);
                
                // Pre-populate with default system message
                if (state.systemMessages.length > 0) {
                    const defaultMessage = state.systemMessages[0];
                    selectedSystemTitle.textContent = defaultMessage.name;
                    selectedSystemContent.textContent = defaultMessage.content;
                    newChatSystemMessage.value = '';
                }
            });

            // New system message button
            newSystemMessageBtn.addEventListener('click', () => {
                openModal(systemMessageModal);
                setTimeout(() => systemMessageName.focus(), 100);
                // Reset the form
                systemMessageName.value = '';
                systemMessageContent.value = '';
            });

            // Create chat button
            createChatBtn.addEventListener('click', async () => {
                const title = newChatTitle.value.trim() || 'New Chat';
                let systemMsg = newChatSystemMessage.value.trim();
                
                // If a saved system message is selected, use that instead
                if (savedSystemMessagesDropdown.value) {
                    const selectedMsg = state.systemMessages.find(m => m.id === savedSystemMessagesDropdown.value);
                    if (selectedMsg) {
                        systemMsg = selectedMsg.content;
                    }
                }
                
                // Default to first system message if none provided
                if (!systemMsg && state.systemMessages.length > 0) {
                    systemMsg = state.systemMessages[0].content;
                }
                
                await createNewChat(title, systemMsg);
                closeModal(newChatModal);
            });

            // Save system message button
            saveSystemMessageBtn.addEventListener('click', async () => {
                const name = systemMessageName.value.trim();
                const content = systemMessageContent.value.trim();
                
                if (!name || !content) {
                    alert('Please provide both a name and prompt content.');
                    return;
                }
                
                const newSystemMessage = {
                    id: generateId(),
                    name,
                    content,
                    createdAt: Date.now()
                };
                
                state.systemMessages.push(newSystemMessage);
                await APIService.saveSystemMessage(newSystemMessage);
                renderSystemMessages();
                updateSystemMessagesDropdown();
                closeModal(systemMessageModal);
            });

            // Change system message button
            changeSystemBtn.addEventListener('click', () => {
                const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
                if (currentChat) {
                    currentSystemPreview.textContent = currentChat.systemMessage;
                    currentSystemMessageInput.value = '';
                    
                    // Populate system prompts
                    renderSystemPrompts();
                    
                    openModal(changeSystemModal);
                }
            });

            // Update system message button
            updateSystemMessageBtn.addEventListener('click', async () => {
                const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
                if (currentChat) {
                    let newSystemMsg = currentSystemMessageInput.value.trim();
                    
                    // If no input and no system prompt selected, keep current
                    if (!newSystemMsg && !document.querySelector('.system-prompt-item.selected')) {
                        closeModal(changeSystemModal);
                        return;
                    }
                    
                    // If a system prompt is selected, use that
                    const selectedPrompt = document.querySelector('.system-prompt-item.selected');
                    if (selectedPrompt && !newSystemMsg) {
                        const promptId = selectedPrompt.dataset.id;
                        const selectedMsg = state.systemMessages.find(m => m.id === promptId);
                        if (selectedMsg) {
                            newSystemMsg = selectedMsg.content;
                        }
                    }
                    
                    // Update chat
                    if (newSystemMsg) {
                        currentChat.systemMessage = newSystemMsg;
                        currentChat.updatedAt = Date.now();
                        await APIService.updateChat(currentChat);
                        updateCurrentChatHeader();
                        closeModal(changeSystemModal);
                    }
                }
            });

            // Clear chat button
            clearChatBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to clear this chat?')) {
                    const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
                    if (currentChat) {
                        currentChat.messages = [];
                        currentChat.updatedAt = Date.now();
                        await APIService.updateChat(currentChat);
                        renderChatMessages();
                    }
                }
            });

            // Send message button
            sendButton.addEventListener('click', sendMessage);

            // Enter key to send message
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';
            });

            // When saved system message dropdown changes in new chat modal
            savedSystemMessagesDropdown.addEventListener('change', () => {
                if (savedSystemMessagesDropdown.value) {
                    const selectedMsg = state.systemMessages.find(m => m.id === savedSystemMessagesDropdown.value);
                    if (selectedMsg) {
                        selectedSystemTitle.textContent = selectedMsg.name;
                        selectedSystemContent.textContent = selectedMsg.content;
                        newChatSystemMessage.value = '';
                    }
                }
            });
        }

        // Render system prompts in the change system modal
        function renderSystemPrompts() {
            systemPromptsContainer.innerHTML = '';
            
            state.systemMessages.forEach(msg => {
                const promptEl = document.createElement('div');
                promptEl.className = 'saved-system-message system-prompt-item';
                promptEl.dataset.id = msg.id;
                
                promptEl.innerHTML = `
                    <div class="saved-system-message-header">
                        <div class="saved-system-message-title">${msg.name}</div>
                    </div>
                    <div class="saved-system-message-content">${msg.content}</div>
                `;
                
                promptEl.addEventListener('click', () => {
                    // Remove selected class from all prompts
                    document.querySelectorAll('.system-prompt-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Add selected class to this prompt
                    promptEl.classList.add('selected');
                    
                    // Clear custom input
                    currentSystemMessageInput.value = '';
                });
                
                systemPromptsContainer.appendChild(promptEl);
            });
        }

        // Fetch model info
        async function fetchModelInfo() {
            try {
                const response = await fetch('/api/info');
                if (response.ok) {
                    const data = await response.json();
                    modelInfo.textContent = data.model || 'Local Model';
                }
            } catch (error) {
                console.error('Error fetching model info:', error);
                modelInfo.textContent = 'Local LLM';
            }
        }

        // Toggle dark mode
        async function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            document.body.classList.toggle('dark-mode', state.isDarkMode);
            themeToggle.innerHTML = state.isDarkMode ? 
                '<i class="fas fa-sun"></i>' : 
                '<i class="fas fa-moon"></i>';
            
            // Save setting to server
            await APIService.saveSettings({ isDarkMode: state.isDarkMode });
        }

        // Open modal
        function openModal(modal) {
            modal.classList.add('active');
        }

        // Close modal
        function closeModal(modal) {
            modal.classList.remove('active');
        }

        // Generate a unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // Format relative time
        function formatRelativeTime(timestamp) {
            const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
            const now = Date.now();
            const diff = timestamp - now;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (Math.abs(days) > 0) {
                return rtf.format(days, 'day');
            }
            
            if (Math.abs(hours) > 0) {
                return rtf.format(hours, 'hour');
            }
            
            if (Math.abs(minutes) > 0) {
                return rtf.format(minutes, 'minute');
            }
            
            return rtf.format(seconds, 'second');
        }

        // Create a new chat
        async function createNewChat(title, systemMessage) {
            const newChat = {
                id: generateId(),
                title: title || 'New Chat',
                systemMessage: systemMessage || 'You are a helpful assistant.',
                messages: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };
            
            state.chats.unshift(newChat);
            state.currentChatId = newChat.id;
            
            // Save to server
            await APIService.saveChat(newChat);
            
            renderChats();
            loadChat(newChat.id);
        }

        // Load a chat
        function loadChat(chatId) {
            state.currentChatId = chatId;
            
            const chat = state.chats.find(chat => chat.id === chatId);
            if (chat) {
                renderChatMessages();
                updateCurrentChatHeader();
                
                // Mark chats as active
                renderChats();
            }
        }

        // Delete a chat
        async function deleteChat(chatId) {
            const index = state.chats.findIndex(chat => chat.id === chatId);
            if (index !== -1) {
                // Delete from server
                await APIService.deleteChat(chatId);
                
                // Remove from state
                state.chats.splice(index, 1);
                
                // If we deleted the current chat, load the newest chat or show empty state
                if (state.currentChatId === chatId) {
                    if (state.chats.length > 0) {
                        state.currentChatId = state.chats[0].id;
                        loadChat(state.currentChatId);
                    } else {
                        state.currentChatId = null;
                        showEmptyChatState();
                    }
                }
                
                renderChats();
            }
        }

        // Delete a system message
        async function deleteSystemMessage(msgId) {
            const index = state.systemMessages.findIndex(msg => msg.id === msgId);
            if (index !== -1) {
                // Don't allow deleting the last system message
                if (state.systemMessages.length <= 1) {
                    alert('Cannot delete the last system prompt. At least one prompt must exist.');
                    return;
                }
                
                // Delete from server
                await APIService.deleteSystemMessage(msgId);
                
                // Remove from state
                state.systemMessages.splice(index, 1);
                
                renderSystemMessages();
                updateSystemMessagesDropdown();
            }
        }

        // Update current chat header
        function updateCurrentChatHeader() {
            const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
            if (currentChat) {
                currentChatTitle.textContent = currentChat.title;
                currentSystemMessage.textContent = `System: ${currentChat.systemMessage.substring(0, 50)}${currentChat.systemMessage.length > 50 ? '...' : ''}`;
            }
        }

        // Render chats list
        function renderChats() {
            chatsList.innerHTML = '';
            
            if (state.chats.length === 0) {
                chatsList.innerHTML = `
                    <li class="empty-state" style="padding: 1rem; text-align: center;">
                        <div class="empty-state-text">No chats yet</div>
                    </li>
                `;
                return;
            }
            
            // Sort chats by updated time (newest first)
            const sortedChats = [...state.chats].sort((a, b) => b.updatedAt - a.updatedAt);
            
            sortedChats.forEach(chat => {
                const li = document.createElement('li');
                li.className = `chat-item ${chat.id === state.currentChatId ? 'active' : ''}`;
                li.dataset.id = chat.id;
                
                // Get first message or placeholder
                const firstMessage = chat.messages.length > 0 ? 
                    chat.messages[0].content.substring(0, 30) + (chat.messages[0].content.length > 30 ? '...' : '') : 
                    'No messages yet';
                
                li.innerHTML = `
                    <div class="chat-item-icon">
                        <i class="fas fa-comment"></i>
                    </div>
                    <div class="chat-item-content">
                        <div class="chat-item-title">${chat.title}</div>
                        <div class="chat-item-date">${formatDate(chat.updatedAt)}</div>
                    </div>
                    <div class="chat-item-actions">
                        <button class="chat-action-btn delete-chat-btn" title="Delete Chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                li.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) {
                        loadChat(chat.id);
                        
                        // Close sidebar on mobile
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                        }
                    }
                });
                
                const deleteBtn = li.querySelector('.delete-chat-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this chat?')) {
                            deleteChat(chat.id);
                        }
                    });
                }
                
                chatsList.appendChild(li);
            });
        }

        // Render system messages list
        function renderSystemMessages() {
            systemMessagesList.innerHTML = '';
            
            if (state.systemMessages.length === 0) {
                systemMessagesList.innerHTML = `
                    <li class="empty-state" style="padding: 1rem; text-align: center;">
                        <div class="empty-state-text">No system prompts yet</div>
                    </li>
                `;
                return;
            }
            
            state.systemMessages.forEach(msg => {
                const li = document.createElement('li');
                li.className = 'system-message-item';
                li.dataset.id = msg.id;
                
                li.innerHTML = `
                    <div class="system-message-item-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="system-message-item-content">
                        <div class="system-message-item-title">${msg.name}</div>
                        <div class="system-message-item-preview">${msg.content.substring(0, 40)}${msg.content.length > 40 ? '...' : ''}</div>
                    </div>
                    <div class="system-message-item-actions">
                        <button class="chat-action-btn use-system-btn" title="Use This Prompt">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="chat-action-btn delete-system-btn" title="Delete Prompt">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Apply system message to current chat
                const useBtn = li.querySelector('.use-system-btn');
                if (useBtn) {
                    useBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
                        if (currentChat) {
                            currentChat.systemMessage = msg.content;
                            currentChat.updatedAt = Date.now();
                            await APIService.updateChat(currentChat);
                            updateCurrentChatHeader();
                            
                            // Show toast notification
                            showToast(`System prompt "${msg.name}" applied to chat`);
                            
                            // Close sidebar on mobile
                            if (window.innerWidth <= 768) {
                                sidebar.classList.remove('active');
                            }
                        } else {
                            // No current chat, open new chat modal with this system message
                            openModal(newChatModal);
                            selectedSystemTitle.textContent = msg.name;
                            selectedSystemContent.textContent = msg.content;
                            savedSystemMessagesDropdown.value = msg.id;
                        }
                    });
                }
                
                // Delete system message
                const deleteBtn = li.querySelector('.delete-system-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this system prompt?')) {
                            deleteSystemMessage(msg.id);
                        }
                    });
                }
                
                // Show full system message on click
                li.addEventListener('click', () => {
                    alert(`${msg.name}\n\n${msg.content}`);
                });
                
                systemMessagesList.appendChild(li);
            });
        }

        // Update system messages dropdown
        function updateSystemMessagesDropdown() {
            // Clear existing options except the first one
            savedSystemMessagesDropdown.innerHTML = '<option value="">-- Select a saved prompt --</option>';
            
            // Add options for each system message
            state.systemMessages.forEach(msg => {
                const option = document.createElement('option');
                option.value = msg.id;
                option.textContent = msg.name;
                savedSystemMessagesDropdown.appendChild(option);
            });
        }

        // Render chat messages
        function renderChatMessages() {
            messagesContainer.innerHTML = '';
            
            const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!currentChat) return;
            
            // Add welcome message if there are no messages
            if (currentChat.messages.length === 0) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message system-message';
                welcomeMsg.innerHTML = `
                    <div class="message-content">
                        This is the start of your conversation. Type a message below to begin.
                    </div>
                `;
                messagesContainer.appendChild(welcomeMsg);
                return;
            }
            
            // Render each message
            currentChat.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;
                
                // Use markdown for assistant messages
                const content = msg.role === 'assistant' ? 
                    marked.parse(msg.content) : 
                    msg.content;
                
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.classList.add('active');
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.classList.remove('active');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast element if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 9999;
                `;
                document.body.appendChild(toastContainer);
            }
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: var(--card-bg);
                color: var(--text-color);
                padding: 12px 16px;
                border-radius: 8px;
                margin-top: 10px;
                box-shadow: var(--shadow-md);
                display: flex;
                align-items: center;
                min-width: 250px;
                max-width: 350px;
                animation: fadeInRight 0.3s, fadeOut 0.5s 2.5s forwards;
                border-left: 4px solid ${type === 'info' ? 'var(--primary-color)' : type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};
            `;
            
            // Add icon based on type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}" style="margin-right: 10px; color: ${type === 'info' ? 'var(--primary-color)' : type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'}"></i>
                <span>${message}</span>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                    if (toastContainer.children.length === 0) {
                        document.body.removeChild(toastContainer);
                    }
                }, 500);
            }, 3000);
        }

        // Send a message
        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText) return;
            
            // If no active chat, create one
            if (!state.currentChatId) {
                await createNewChat('New Chat', state.systemMessages[0]?.content || 'You are a helpful assistant.');
            }
            
            // Clear input and reset height
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Disable input during processing
            userInput.disabled = true;
            sendButton.disabled = true;
            
            const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!currentChat) return;
            
            // Add user message to current chat
            currentChat.messages.push({
                role: 'user',
                content: messageText,
                timestamp: Date.now()
            });
            
            // Update UI
            renderChatMessages();
            currentChat.updatedAt = Date.now();
            await APIService.updateChat(currentChat);
            renderChats();
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Prepare messages for API
                const messages = [
                    { role: 'system', content: currentChat.systemMessage },
                    ...currentChat.messages
                ];
                
                // Send request to API
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 512
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Add assistant response to chat
                currentChat.messages.push({
                    role: 'assistant',
                    content: data.text,
                    timestamp: Date.now()
                });
                
                // Update UI
                hideTypingIndicator();
                renderChatMessages();
                currentChat.updatedAt = Date.now();
                await APIService.updateChat(currentChat);
                renderChats();
                
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                
                // Add error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message system-message';
                errorMsg.innerHTML = `
                    <div class="message-content">
                        Error: ${error.message}. Please try again.
                    </div>
                `;
                messagesContainer.appendChild(errorMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Show toast notification
                showToast(`Error: ${error.message}`, 'error');
                
            } finally {
                // Re-enable input
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        // Add these styles for toast animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes fadeOut {
                from {
                    opacity: 1;
                }
                to {
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>